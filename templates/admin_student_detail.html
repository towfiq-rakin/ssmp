{% extends "base.html" %}

{% block title %}Student Details - ScholarMate{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="back-nav">
        <a href="{{ url_for('admin.students') }}" class="btn btn-back">‚Üê Back to Students</a>
    </div>

    <h1 class="page-title">Student Details</h1>

    <div class="student-info-card">
        <h2>Personal Information</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Student ID:</span>
                <span class="info-value">{{ student.student_id }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Registration No:</span>
                <span class="info-value">{{ student.reg_no }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Name:</span>
                <span class="info-value">{{ student.name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value">{{ student.email }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Session:</span>
                <span class="info-value">{{ student.session }}</span>
            </div>
            {% if department %}
            <div class="info-item">
                <span class="info-label">Department:</span>
                <span class="info-value">{{ department.name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Faculty:</span>
                <span class="info-value">{{ department.faculty }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if academic_record %}
    <div class="student-info-card">
        <h2>Academic Record</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">CGPA (Auto-calculated):</span>
                <span class="info-value">{{ "%.2f"|format(academic_record.cgpa) }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Current Semester:</span>
                <span class="info-value">Semester {{ academic_record.current_semester }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">{% if academic_record.get_last_completed_semester() and academic_record.get_last_completed_semester() > 0 %}Semester {{ academic_record.get_last_completed_semester() }} GPA{% else %}Last Semester GPA{% endif %}:</span>
                <span class="info-value">{{ "%.2f"|format(academic_record.get_last_semester_gpa()) if academic_record.get_last_semester_gpa() else 'N/A' }}</span>
            </div>
        </div>
        
        <h3 style="margin-top: 20px;">Semester GPAs</h3>
        <div class="semester-grid">
            {% for i in range(1, 9) %}
            {% if i < academic_record.current_semester %}
            <div class="semester-item">
                <span class="semester-label">Semester {{ i }}:</span>
                {% set gpa = academic_record['semester_' ~ i ~ '_gpa'] %}
                <span class="semester-value">{{ "%.2f"|format(gpa) if gpa else 'N/A' }}</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <div class="update-section">
            <button class="btn btn-update-record" onclick="showUpdateForm()">Update Academic Record</button>
        </div>
        
        <div id="update-form" class="update-form" style="display: none;">
            <h3>Update Academic Record</h3>
            <form id="academic-update-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="current-semester">Current Semester:</label>
                        <select id="current-semester" name="current_semester" required>
                            {% for i in range(1, 9) %}
                            <option value="{{ i }}" {% if academic_record.current_semester == i %}selected{% endif %}>Semester {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <h4>Semester GPAs</h4>
                <div class="semester-inputs-grid">
                    {% for i in range(1, 9) %}
                    <div class="form-group">
                        <label for="semester-{{ i }}-gpa">Semester {{ i }} GPA:</label>
                        {% set gpa = academic_record['semester_' ~ i ~ '_gpa'] %}
                        <input type="number" id="semester-{{ i }}-gpa" name="semester_{{ i }}_gpa" 
                               min="0" max="4" step="0.01" 
                               value="{{ '%.2f'|format(gpa) if gpa else '' }}" 
                               placeholder="Not set">
                    </div>
                    {% endfor %}
                </div>
                <p class="help-text" style="margin-top: 10px;">Leave blank for semesters not yet completed. CGPA will be auto-calculated from non-blank semesters.</p>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-save">Save Changes</button>
                    <button type="button" class="btn btn-cancel" onclick="hideUpdateForm()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="student-info-card">
        <h2>Academic Record</h2>
        <p class="no-results">No academic record found for this student.</p>
    </div>
    {% endif %}
</div>

<script>
function showUpdateForm() {
    document.getElementById('update-form').style.display = 'block';
    document.querySelector('.btn-update-record').style.display = 'none';
}

function hideUpdateForm() {
    document.getElementById('update-form').style.display = 'none';
    document.querySelector('.btn-update-record').style.display = 'inline-block';
}

document.getElementById('academic-update-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const currentSemester = parseInt(document.getElementById('current-semester').value);
    
    // Collect semester GPAs
    const semesterGpas = {};
    for (let i = 1; i <= 8; i++) {
        const gpaInput = document.getElementById(`semester-${i}-gpa`);
        const value = gpaInput.value.trim();
        
        if (value !== '') {
            const gpa = parseFloat(value);
            
            // Validate GPA
            if (gpa < 0 || gpa > 4) {
                alert(`Semester ${i} GPA must be between 0.00 and 4.00`);
                return;
            }
            
            semesterGpas[i] = gpa;
        } else {
            semesterGpas[i] = null;
        }
    }
    
    if (!confirm('Are you sure you want to update this academic record? CGPA will be auto-calculated.')) {
        return;
    }
    
    // Send update request
    fetch('/admin/student/{{ student.student_id }}/academic-record/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_semester: currentSemester,
            semester_gpas: semesterGpas
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message + '\nNew CGPA: ' + data.cgpa.toFixed(2));
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the academic record.');
    });
});
</script>

<style>
.update-section {
    margin-top: 20px;
    text-align: center;
}

.btn-update-record {
    background-color: #2196f3;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

.btn-update-record:hover {
    background-color: #1976d2;
}

.update-form {
    margin-top: 20px;
    padding: 20px;
    background-color: #f5f5f5;
    border-radius: 8px;
}

.update-form h3 {
    margin-bottom: 20px;
    color: #333;
}

.update-form h4 {
    margin-top: 20px;
    margin-bottom: 15px;
    color: #555;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: bold;
    margin-bottom: 5px;
    color: #555;
}

.form-group input,
.form-group select {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1em;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #2196f3;
}

.help-text {
    font-size: 0.85em;
    color: #666;
    margin-top: 5px;
}

.semester-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-top: 15px;
}

.semester-item {
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.semester-label {
    font-weight: bold;
    color: #555;
    font-size: 0.9em;
}

.semester-value {
    font-size: 1.2em;
    color: #2196f3;
}

.semester-inputs-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-save {
    background-color: #4caf50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

.btn-save:hover {
    background-color: #45a049;
}

.btn-cancel {
    background-color: #f44336;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

.btn-cancel:hover {
    background-color: #da190b;
}
</style>
{% endblock %}
